#!/bin/bash

if [ $# -lt 2 ]; then
    echo "usage: dstress <program> <folder z testami> [timelimit w sekundach]"
    exit 1
fi 

TESTS=$2
SOL=$1
N_CORES=$(nproc --all)
TL=10
if [ $# -ge 3 ]; then
    TL=$3
fi

cfast $SOL

trap 'echo "Aborted."; pkill -P $$; exit 1' INT

mkdir -p .solutions || true
LOG=.solutions/run.log

ls -d $PWD/$TESTS/*.in | parallel -j$N_CORES "evaluator $SOL {} $TL" | tee $LOG
OK=$(grep -c "[OK]" $LOG)
TLE=$(grep -c "[TLE]" $LOG)
FAIL=$(grep -c "[FAIL]" $LOG)
RE=$(grep -c "[RE]" $LOG)

TOTAL=$((OK+TLE+FAIL+RE))

echo $OK/$TOTAL passed
if [ $OK -ne $TOTAL ]; then
    echo "OK: $OK"
    echo "WA: $FAIL"
    echo "TLE: $TLE"
    echo "RE: $RE"
fi

